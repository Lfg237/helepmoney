<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HelepMoney - Abonnement Mensuel</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:20px;background:linear-gradient(120deg,#f6d365,#fda085);color:#333}
.container{max-width:900px;margin:0 auto;background:rgba(255,255,255,0.95);padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
h1{color:#ff5722;text-align:center}
input,textarea,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:2px solid #ff5722;outline:none}
button{background:#ff5722;color:white;font-weight:bold;cursor:pointer;border:none}
.hidden{display:none}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{width:95%;max-width:500px;background:white;padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.3)}
.countdown{font-weight:bold;color:#d84315}
.success{color:green;font-weight:bold}
.error{color:red;font-weight:bold}
.row{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>

<div class="container">
<h1>HelepMoney — Gestion Abonnements</h1>

<p>Montant : <b>1000 XAF</b> — Durée : <b>30 jours</b></p>
<p>Redirection après validation : <b>https://helepmoney.vercel.app/?abonne=A004</b></p>

<h3>Abonné actif :</h3>
<p><b>Nom :</b> <span id="abonneNom">Pauline Mbarga</span></p>
<p><b>Numéros :</b> OM:655001122 | MoMo:676000111</p>
<p><b>Temps restant :</b> <span id="countdown" class="countdown">--:--:--:--</span></p>

<button id="renewBtn">Renouveler l'abonnement</button>
<p id="userMsg"></p>
</div>

<div class="overlay hidden" id="popup">
<div class="modal">
<h2>Renouvellement — 1000 XAF / 30 jours</h2>
<p>Choisissez une méthode :</p>

<h4>1) Paiement Mobile Money</h4>
<p>Bénéficiaire : Loveline Wirnkar | MoMo:676353859 | OM:640647072</p>
<textarea id="momoMsg" rows="4" placeholder="Collez le message complet MoMo ici"></textarea>
<button id="validateMomo">Valider paiement</button>
<p id="momoFeedback"></p>

<h4>2) Code d'accès admin</h4>
<input type="password" id="adminCodeInput" placeholder="Entrez le code 233233">
<button id="validateCode">Valider code</button>
<p id="codeFeedback"></p>

<button id="closePopup">Annuler</button>
</div>
</div>

<script>
const REDIRECT_URL="https://helepmoney.vercel.app/?abonne=A004";
const SUBSCRIPTION_MS=1000*60*60*24*30;
const MIN_AGE_MS=10*60*1000;
let subscriptionExpiry=Date.now()-1000*60*5; // expiré pour test
let transactionsUsed=[];

const countdownEl=document.getElementById("countdown");
const userMsg=document.getElementById("userMsg");
const popup=document.getElementById("popup");
const renewBtn=document.getElementById("renewBtn");
const momoMsgEl=document.getElementById("momoMsg");
const validateMomoBtn=document.getElementById("validateMomo");
const momoFeedback=document.getElementById("momoFeedback");
const adminCodeInput=document.getElementById("adminCodeInput");
const validateCodeBtn=document.getElementById("validateCode");
const codeFeedback=document.getElementById("codeFeedback");
const closePopupBtn=document.getElementById("closePopup");

function startCountdown(){
  clearInterval(window.countdownInterval);
  function update(){
    const diff=subscriptionExpiry-Date.now();
    if(diff<=0){
      countdownEl.textContent="00:00:00:00";
      clearInterval(window.countdownInterval);
      userMsg.textContent="⏳ Abonnement expiré !";
      return;
    }
    const d=Math.floor(diff/(1000*60*60*24));
    const h=Math.floor((diff%(1000*60*60*24))/(1000*60*60));
    const m=Math.floor((diff%(1000*60*60))/(1000*60));
    const s=Math.floor((diff%(1000*60))/1000);
    countdownEl.textContent=`${d.toString().padStart(2,"0")}:${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
  }
  update();
  window.countdownInterval=setInterval(update,1000);
}
startCountdown();

renewBtn.addEventListener("click",()=>{popup.classList.remove("hidden");});

closePopupBtn.addEventListener("click",()=>{popup.classList.add("hidden");});

validateMomoBtn.addEventListener("click",()=>{
  const msg=momoMsgEl.value.trim();
  if(!msg){momoFeedback.textContent="❌ Collez le message"; return;}
  const txIdMatch=msg.match(/Financial Transaction Id:\s*(\d+)/i);
  if(!txIdMatch){momoFeedback.textContent="❌ ID transaction non trouvé"; return;}
  const txId=txIdMatch[1];
  if(transactionsUsed.includes(txId)){momoFeedback.textContent="❌ Transaction déjà utilisée"; return;}
  const dateMatch=msg.match(/à (\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
  const txDate=dateMatch?new Date(dateMatch[1]):new Date();
  if(Date.now()-txDate.getTime()<MIN_AGE_MS){momoFeedback.textContent="❌ Transaction trop récente (<10min)"; return;}
  if(!msg.includes("Pauline Mbarga") && !msg.includes("676000111")){momoFeedback.textContent="❌ Nom ou numéro incorrect"; return;}
  // succès
  transactionsUsed.push(txId);
  subscriptionExpiry=Date.now()+SUBSCRIPTION_MS;
  startCountdown();
  momoFeedback.textContent="✅ Paiement validé !";
  popup.classList.add("hidden");
  userMsg.textContent="✅ Abonnement renouvelé.";
  setTimeout(()=>{window.location.href=REDIRECT_URL;},1200);
});

validateCodeBtn.addEventListener("click",()=>{
  if(adminCodeInput.value.trim()!=="233233"){codeFeedback.textContent="❌ Code incorrect"; return;}
  subscriptionExpiry=Date.now()+SUBSCRIPTION_MS;
  startCountdown();
  codeFeedback.textContent="✅ Code valide !";
  popup.classList.add("hidden");
  userMsg.textContent="✅ Abonnement renouvelé via code.";
  setTimeout(()=>{window.location.href=REDIRECT_URL;},1200);
});
</script>
</body>
</html>