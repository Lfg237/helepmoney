<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>compte marchand</title>
<style>
  body { font-family: 'Arial', sans-serif; background: linear-gradient(120deg, #f6d365, #fda085); margin:0; padding:0; }
  .container { max-width: 900px; margin: 50px auto; padding: 20px; background: rgba(255,255,255,0.95); border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
  h1,h2 { text-align:center; color:#ff5722; text-shadow:1px 1px #ffe0b2; }
  table { width:100%; border-collapse: collapse; margin-bottom:30px; }
  th,td { padding:12px; text-align:center; border-bottom:1px solid #ddd; }
  th { background:#ff9800; color:white; text-transform:uppercase; }
  tr:nth-child(even){background:#ffe0b2;}
  tr:hover{background:#ffd54f;}
  input, textarea { padding:10px; border-radius:5px; border:2px solid #ff5722; transition:0.3s; }
  button { padding:10px 20px; border:none; border-radius:5px; background:#ff5722; color:white; font-weight:bold; cursor:pointer; transition:0.3s; }
  .error { color:red; margin-top:10px; }
  .hidden { display:none; }
  .admin-access, .payment-section { text-align:center; margin-bottom:20px; }
</style>
</head>
<body>
<div class="container">
  <h1>üìä helepmoney compte marchand </h1>

  <!-- Tableau public -->
  <table>
    <thead>
      <tr>
        <th>Nom Entreprise</th>
        <th>Propri√©taire</th>
        <th>Num√©ro Mobile Money</th>
        <th>Fournisseur</th>
      </tr>
    </thead>
    <tbody id="publicTable"></tbody>
  </table>

  <!-- Acc√®s admin -->
  <div class="admin-access">
    <label for="adminCode">Code Administrateur :</label>
    <input type="password" id="adminCode" placeholder="Entrez le code">
    <button id="accessBtn">Acc√©der</button>
    <p id="accessMsg" class="error"></p>
  </div>

  <!-- Tableau admin -->
  <div id="adminTableContainer" class="hidden">
    <h2>üìã Tableau Administrateur</h2>
    <table>
      <thead>
        <tr>
          <th>Entreprise</th>
          <th>Propri√©taire</th>
          <th>Num√©ro</th>
          <th>Fournisseur</th>
          <th>Montants accept√©s</th>
          <th>Montants restants</th>
          <th>Paiements valid√©s</th>
          <th>Total re√ßu</th>
        </tr>
      </thead>
      <tbody id="adminTable"></tbody>
    </table>
  </div>

  <!-- Paiement utilisateur -->
  <div class="payment-section">
    <h2>Paiement Mobile Money</h2>
    <p>Collez le message re√ßu apr√®s votre paiement :</p>
    <textarea id="inputPaiement" rows="4" placeholder="Collez le message Mobile Money"></textarea>
    <button id="verifPaiementBtn">Valider le paiement</button>
  </div>
</div>

<script>
  const ADMIN_CODE = "233233";

  // abonn√©s
  const abonn√©s = [
    { entreprise:"FACILITATEURS", proprietaire:"Jean Dupont", numero:"655123456", fournisseur:"Orange Money", montants:["2000","3000"], id:"123456" },
    { entreprise:"TECH SOLUTIONS", proprietaire:"LOVELINE KINYUY WIRNKAR", numero:"676353859", fournisseur:"MTN MoMo", montants:["50","25","55"], id:"654321" },
    { entreprise:"ABC ENTERPRISE", proprietaire:"Paul Etoundi", numero:"699112233", fournisseur:"Orange Money", montants:["2500"], id:"987654" }
  ];

  const STORAGE_ETAT = "etatPaiements_v1";
  const STORAGE_TX = "processedTxIds_v1";

  const etatPaiements = JSON.parse(localStorage.getItem(STORAGE_ETAT)) || {};
  const processedTxIds = JSON.parse(localStorage.getItem(STORAGE_TX)) || {};

  abonn√©s.forEach(a => {
    if(!etatPaiements[a.id]){
      etatPaiements[a.id] = { montantsRestants: [...a.montants], compteur: 0, totalDepenses: 0 };
    }
  });

  function saveAll(){
    localStorage.setItem(STORAGE_ETAT, JSON.stringify(etatPaiements));
    localStorage.setItem(STORAGE_TX, JSON.stringify(processedTxIds));
  }

  // affichage public
  const publicTable = document.getElementById("publicTable");
  function fillPublicTable(){
    publicTable.innerHTML = "";
    abonn√©s.forEach(a => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${a.entreprise}</td><td>${a.proprietaire}</td><td>${a.numero}</td><td>${a.fournisseur}</td>`;
      publicTable.appendChild(row);
    });
  }
  fillPublicTable();

  // admin UI
  const accessBtn = document.getElementById("accessBtn");
  const adminCodeInput = document.getElementById("adminCode");
  const accessMsg = document.getElementById("accessMsg");
  const adminTableContainer = document.getElementById("adminTableContainer");
  const adminTable = document.getElementById("adminTable");

  function updateAdminTable(){
    adminTable.innerHTML = "";
    abonn√©s.forEach(a => {
      const et = etatPaiements[a.id];
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${a.entreprise}</td>
        <td>${a.proprietaire}</td>
        <td>${a.numero}</td>
        <td>${a.fournisseur}</td>
        <td>${a.montants.join(", ")}</td>
        <td>${et.montantsRestants.join(", ") || "Aucun"}</td>
        <td>${et.compteur}</td>
        <td>${et.totalDepenses}</td>
      `;
      adminTable.appendChild(tr);
    });
  }

  accessBtn.addEventListener("click", () => {
    const code = adminCodeInput.value.trim();
    if(code === ADMIN_CODE){
      accessMsg.textContent = "Acc√®s Admin valid√© !";
      accessMsg.style.color = "green";
      adminTableContainer.classList.remove("hidden");
      updateAdminTable();
    } else {
      accessMsg.textContent = "Code incorrect !";
      accessMsg.style.color = "red";
      adminTableContainer.classList.add("hidden");
    }
  });

  // utilitaires
  function hashStringHex(s){
    let h = 5381;
    for(let i=0;i<s.length;i++){
      h = ((h << 5) + h) + s.charCodeAt(i);
      h = h & 0xFFFFFFFF;
    }
    return (h >>> 0).toString(16);
  }

  function parseAmountNumber(str){
    if(!str && str !== 0) return 0;
    let s = String(str).replace(/\s/g, '').replace(/[^0-9.,-]/g,'').replace(',', '.');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  // NE PAS consid√©rer candidate comme txId s'il ressemble √† un t√©l√©phone ou √† un montant
  function looksLikePhoneOrAmount(candidate, messageRaw, subscriber){
    const digitsOnly = /^\d+$/.test(candidate);
    const phone = String(subscriber.numero).replace(/\D/g,'');
    if(phone && (candidate === phone || phone.endsWith(candidate) || candidate.endsWith(phone))) return true;
    if(digitsOnly && candidate.length <= 7) return true;
    const msgNums = (String(messageRaw).match(/[\d]+(?:[.,]\d+)?/g) || []).map(n => n.replace(',', '.'));
    if(msgNums.includes(candidate.replace(',', '.'))) return true;
    return false;
  }

  // extraction tx id corrig√©e
  function extractTransactionId(messageRaw, subscriber){
    // 1) chercher "transaction Id"
    const transMatch = messageRaw.match(/transaction\s+id[:\-]?\s*([0-9A-Za-z\-]{6,})/i);
    if(transMatch && transMatch[1]){
      return transMatch[1];
    }

    // 2) sinon chercher ref/trx/id mais ignorer "Reference: 0"
    const labeled = messageRaw.match(/\b(?:r√©f(?:√©rence)?|ref|trx|trn|id|code|n[¬∞¬∫]|no)\s*[:\-]?\s*([A-Za-z0-9\-]{4,})\b/i);
    if(labeled && labeled[1] && labeled[1] !== "0"){
      const cand = String(labeled[1]);
      if(!looksLikePhoneOrAmount(cand, messageRaw, subscriber)) return cand;
    }

    // 3) fallback : hash du message
    return "MSG_" + hashStringHex(messageRaw);
  }

  // validation paiement
  const verifPaiementBtn = document.getElementById("verifPaiementBtn");
  const inputPaiement = document.getElementById("inputPaiement");

  verifPaiementBtn.addEventListener("click", ()=>{
    const messageRaw = inputPaiement.value.trim();
    if(!messageRaw){ alert("Collez d'abord le message Mobile Money."); return; }
    verifierMessage(messageRaw);
  });

  function verifierMessage(messageRaw){
    const message = messageRaw.toLowerCase();

    for(const a of abonn√©s){
      const numeroOK = message.includes(a.numero.slice(-9));
      const nomOK = message.includes(a.proprietaire.toLowerCase().split(" ")[0]);

      if(numeroOK && nomOK){
        const txId = extractTransactionId(messageRaw, a);

        if(processedTxIds[txId]){
          const info = processedTxIds[txId];
          alert(`‚ö†Ô∏è Transaction d√©j√† trait√©e (id=${txId}).\nD√©j√† valid√©e pour l'abonn√© id=${info.abonneId}, montant=${info.montant} le ${new Date(info.date).toLocaleString()}`);
          return false;
        }

        const messageNumbers = (messageRaw.match(/[\d]+(?:[.,]\d+)?/g) || []).map(n => n.replace(',', '.'));
        const allowedAmounts = a.montants.map(m => String(m).replace(',', '.'));
        let matchedAmount = null;
        for(const am of allowedAmounts){
          if(messageNumbers.includes(am)){
            matchedAmount = am;
            break;
          }
        }

        if(!matchedAmount){
          alert(`‚ùå Aucun montant autoris√© trouv√© dans le message pour ${a.entreprise}. Montants accept√©s : ${a.montants.join(", ")}`);
          return false;
        }

        const et = etatPaiements[a.id];
        const idxRest = et.montantsRestants.findIndex(m => String(m).replace(',', '.') === matchedAmount);
        if(idxRest !== -1){
          et.montantsRestants.splice(idxRest, 1);
        }
        const montantNum = parseAmountNumber(matchedAmount);
        et.compteur = (et.compteur || 0) + 1;
        et.totalDepenses = (et.totalDepenses || 0) + montantNum;

        processedTxIds[txId] = { abonneId: a.id, montant: matchedAmount, date: new Date().toISOString() };

        saveAll();
        updateAdminTable();
        alert(`‚úÖ Paiement valid√© pour ${a.entreprise} ‚Äî montant: ${matchedAmount} ‚Äî txId: ${txId}`);
        return true;
      }
    }

    alert("Message invalide : num√©ro ou nom non reconnus.");
    return false;
  }

  // init affichage admin
  updateAdminTable();

</script>
</body>
</html>