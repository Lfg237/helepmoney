<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HelepMoney</title>
<style>
body{font-family:'Arial',sans-serif;background:linear-gradient(120deg,#f6d365,#fda085);margin:0;padding:0;}
.container{max-width:900px;margin:30px auto;padding:20px;background:rgba(255,255,255,0.95);border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.2);}
h1,h2,h3{color:#ff5722;text-align:center;}
b{font-weight:bold;}
.hidden{display:none;}
input,button,textarea{width:100%;padding:10px;margin:5px 0;border-radius:5px;border:2px solid #ff5722;}
button{background:#ff5722;color:white;font-weight:bold;cursor:pointer;border:none;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{padding:8px;text-align:center;border:1px solid #ddd;}
th{background:#ff9800;color:white;}
tr:hover{background:#ffe0b2;cursor:pointer;}
ul{list-style:none;padding:0;}
li{padding:5px;background:#ffd54f;margin:3px 0;border-radius:5px;}
</style>
</head>
<body>
<div class="container" id="adminSection">
<h1><b>HelepMoney - Administration</b></h1>
<label>Code Admin :</label>
<input type="password" id="adminCode">
<button id="accessBtn">Accéder</button>
<p id="accessMsg"></p>
<table>
<thead>
<tr>
<th>Entreprise</th>
<th>Propriétaire</th>
<th>Comptes</th>
<th>Montants</th>
<th>Lien abonné</th>
<th>État</th>
</tr>
</thead>
<tbody id="adminTable"></tbody>
</table>
</div>

<div class="container hidden" id="userSection">
<h1><b>HelepMoney</b></h1>
<input type="text" id="searchAbonne" placeholder="Rechercher un abonné...">
<ul id="abonneList"></ul>

<div id="abonneDetail" class="hidden">
<h3 id="abonneNom"></h3>
<p><b>Entreprise :</b> <span id="abonneEntreprise"></span></p>
<p><b>Propriétaire :</b> <span id="abonneProprietaire"></span></p>
<p><b>Comptes :</b> <span id="abonneComptes"></span></p>
<p><b>Montants autorisés :</b> <span id="abonneMontants"></span></p>
<textarea id="messagePaiement" rows="4" placeholder="Collez le message Mobile Money"></textarea>
<input type="number" id="montantPaiement" placeholder="Montant payé">
<button id="validerPaiement">Valider le paiement</button>
<p id="msgPaiement"></p>
<button id="retourAdmin">Retour Administration</button>
</div>

<script>
const ADMIN_CODE="233233";

// Liste des abonnés avec ID interne
const abonnés=[
  {id:"A001", entreprise:"FACILITATEURS", proprietaire:"Jean Dupont", numero:"655123456", montants:[""], ouvert:true, transactions:[]},
  {id:"A002", entreprise:"TECH SOLUTIONS", proprietaire:"LOVELINE ", numero:"676353859", montants:[""], ouvert:true, transactions:[]}
{id:"A003", entreprise:"maçon", proprietaire:"kegni Ismaël ", numero:"656207223", montants:[""], ouvert:true, transactions:[]}
];

// Liste globale des IDs de transaction déjà utilisés
const transactionsUtilisees = [];

const adminSection=document.getElementById("adminSection");
const userSection=document.getElementById("userSection");
const adminTable=document.getElementById("adminTable");
const accessBtn=document.getElementById("accessBtn");
const adminCodeInput=document.getElementById("adminCode");
const accessMsg=document.getElementById("accessMsg");
const searchAbonne=document.getElementById("searchAbonne");
const abonneList=document.getElementById("abonneList");
const abonneDetail=document.getElementById("abonneDetail");
const abonneNom=document.getElementById("abonneNom");
const abonneEntreprise=document.getElementById("abonneEntreprise");
const abonneProprietaire=document.getElementById("abonneProprietaire");
const abonneComptes=document.getElementById("abonneComptes");
const abonneMontants=document.getElementById("abonneMontants");
const messagePaiement=document.getElementById("messagePaiement");
const montantPaiement=document.getElementById("montantPaiement");
const validerPaiement=document.getElementById("validerPaiement");
const msgPaiement=document.getElementById("msgPaiement");
const retourAdmin=document.getElementById("retourAdmin");

// Mettre à jour le tableau admin
function updateAdminTable(){
  adminTable.innerHTML="";
  abonnés.forEach(a=>{
    const lien=`https://helepmoney.vercel.app/?abonne=${a.id}`;
    const btnEtat=a.ouvert?'Ouvert':'Fermé';
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${a.entreprise}</td><td>${a.proprietaire}</td><td>${a.numero}</td><td>${a.montants.join(", ")}</td><td><a href="${lien}" target="_blank">Voir</a></td><td>${btnEtat}</td>`;
    adminTable.appendChild(tr);
  });
}

// Accès admin
accessBtn.addEventListener("click",()=>{
  if(adminCodeInput.value.trim()===ADMIN_CODE){
    accessMsg.textContent="✅ Accès autorisé";
    updateAdminTable();
  }else{
    accessMsg.textContent="❌ Code incorrect";
  }
});

// Ouvrir un abonné depuis le tableau
function openAbonne(id){
  const ab=abonnés.find(a=>a.id===id);
  if(!ab || !ab.ouvert) return alert("Abonné fermé ou introuvable");
  adminSection.classList.add("hidden");
  userSection.classList.remove("hidden");
  showAbonne(ab);
}

// Afficher les détails d'un abonné
function showAbonne(a){
  abonneDetail.classList.remove("hidden");
  abonneNom.textContent=a.proprietaire;
  abonneEntreprise.textContent=a.entreprise;
  abonneProprietaire.textContent=a.proprietaire;
  abonneComptes.textContent=a.numero;
  abonneMontants.textContent=a.montants.join(", ");
  abonneNom.dataset.id=a.id;
  messagePaiement.value="";
  montantPaiement.value="";
  msgPaiement.textContent="";
}

// Recherche abonnés
searchAbonne.addEventListener("input",()=>{
  const val=searchAbonne.value.toLowerCase();
  abonneList.innerHTML="";
  abonnés.filter(a=>a.proprietaire.toLowerCase().includes(val)||a.entreprise.toLowerCase().includes(val)).forEach(a=>{
    if(a.ouvert){
      const li=document.createElement("li");
      li.textContent=a.proprietaire+" ("+a.entreprise+")";
      li.addEventListener("click",()=>showAbonne(a));
      abonneList.appendChild(li);
    }
  });
});

// Validation paiement
validerPaiement.addEventListener("click",()=>{
  const message=messagePaiement.value.trim();
  const montant=parseFloat(montantPaiement.value.trim());
  if(!message || !montant){ msgPaiement.textContent="Veuillez remplir message et montant."; return; }

  const regex=/transaction\s*id\s*[:\-]?\s*(\d+)/i;
  const match=message.match(regex);
  if(!match){ msgPaiement.textContent="ID transaction non trouvé."; return; }
  const idTransaction=match[1];

  if(transactionsUtilisees.includes(idTransaction)){
    msgPaiement.textContent="Cette transaction a déjà été utilisée : paiement non valide.";
    return;
  }

  // Vérifier le nom et le numéro dans le message
  const ab=abonnés.find(a=>a.id===abonneNom.dataset.id);
  if(!ab || !message.toLowerCase().includes(ab.proprietaire.toLowerCase()) || !message.includes(ab.numero)){
    msgPaiement.textContent="Le paiement ne correspond pas à cet abonné.";
    return;
  }

  // Valider le paiement
  transactionsUtilisees.push(idTransaction);
  ab.transactions.push({id:idTransaction,montant:montant});
  msgPaiement.textContent=`✅ Paiement validé pour ${ab.proprietaire}`;
  messagePaiement.value="";
  montantPaiement.value="";
});

// Retour admin
retourAdmin.addEventListener("click",()=>{
  userSection.classList.add("hidden");
  adminSection.classList.remove("hidden");
  abonneDetail.classList.add("hidden");
});

// Ouvrir abonné depuis lien URL
window.addEventListener("load",()=>{
  const params=new URLSearchParams(window.location.search);
  const idAbonne=params.get("abonne");
  if(idAbonne){
    const ab=abonnés.find(a=>a.id===idAbonne);
    if(ab && ab.ouvert){
      adminSection.classList.add("hidden");
      userSection.classList.remove("hidden");
      showAbonne(ab);
    }
  }
});
</script>
</body>
</html>