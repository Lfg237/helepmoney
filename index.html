<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HelpMoney</title>
<style>
body{font-family:'Arial',sans-serif;background:linear-gradient(120deg,#f6d365,#fda085);margin:0;padding:0;}
.container{max-width:900px;margin:30px auto;padding:20px;background:rgba(255,255,255,0.95);border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.2);}
h1,h2,h3{color:#ff5722;text-align:center;}
b{font-weight:bold;}
.hidden{display:none;}
input,button,textarea{width:100%;padding:10px;margin:5px 0;border-radius:5px;border:2px solid #ff5722;}
button{background:#ff5722;color:white;font-weight:bold;cursor:pointer;border:none;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{padding:8px;text-align:center;border:1px solid #ddd;}
th{background:#ff9800;color:white;}
tr:hover{background:#ffe0b2;cursor:pointer;}
ul{list-style:none;padding:0;}
li{padding:5px;background:#ffd54f;margin:3px 0;border-radius:5px;cursor:pointer;}
</style>
</head>
<body>

<div class="container" id="adminSection">
<h1><b>HelpMoney - Administration</b></h1>
<label>Code Admin :</label>
<input type="password" id="adminCode">
<button id="accessBtn">Accéder</button>
<p id="accessMsg"></p>
<table>
<thead>
<tr>
<th>Entreprise</th>
<th>Propriétaire</th>
<th>Comptes</th>
<th>Montants</th>
<th>Montants restants</th>
<th>Paiements validés</th>
<th>Total reçu</th>
<th>Lien abonné</th>
<th>État</th>
</tr>
</thead>
<tbody id="adminTable"></tbody>
</table>
</div>

<div class="container hidden" id="userSection">
<h1><b>HelpMoney</b></h1>
<input type="text" id="searchAbonne" placeholder="Rechercher un abonné...">
<ul id="abonneList"></ul>

<div id="abonneDetail" class="hidden">
<h3 id="abonneNom"></h3>
<p><b>Entreprise :</b> <span id="abonneEntreprise"></span></p>
<p><b>Propriétaire :</b> <span id="abonneProprietaire"></span></p>
<p><b>Comptes :</b> <span id="abonneComptes"></span></p>
<p><b>Montants autorisés :</b> <span id="abonneMontants">—</span></p>
<textarea id="messagePaiement" rows="4" placeholder="Collez le message Mobile Money"></textarea>
<input type="number" id="montantPaiement" placeholder="Montant payé">
<button id="validerPaiement">Valider le paiement</button>
<p id="msgPaiement"></p>
<button id="retourAdmin">Retour Administration</button>
</div>

<script>
const ADMIN_CODE="233233";
const abonnés=[
  {id:"123456", entreprise:"FACILITATEURS", proprietaire:"Jean Dupont", comptes:[{fournisseur:"Orange Money", numero:"655123456"},{fournisseur:"MTN MoMo", numero:"677889900"}], montants:["2000","3000"], ouvert:true, compteur:0, totalDepenses:0, transactions:[]},
  {id:"654321", entreprise:"TECH SOLUTIONS", proprietaire:"LOVELINE KINYUY WIRNKAR", comptes:[{fournisseur:"MTN MoMo", numero:"676353859"},{fournisseur:"Orange Money", numero:"699001122"}], montants:["50","25","55"], ouvert:true, compteur:0, totalDepenses:0, transactions:[]}
];

const adminSection=document.getElementById("adminSection");
const userSection=document.getElementById("userSection");
const adminTable=document.getElementById("adminTable");
const accessBtn=document.getElementById("accessBtn");
const adminCodeInput=document.getElementById("adminCode");
const accessMsg=document.getElementById("accessMsg");
const searchAbonne=document.getElementById("searchAbonne");
const abonneList=document.getElementById("abonneList");
const abonneDetail=document.getElementById("abonneDetail");
const abonneNom=document.getElementById("abonneNom");
const abonneEntreprise=document.getElementById("abonneEntreprise");
const abonneProprietaire=document.getElementById("abonneProprietaire");
const abonneComptes=document.getElementById("abonneComptes");
const abonneMontants=document.getElementById("abonneMontants");
const messagePaiement=document.getElementById("messagePaiement");
const montantPaiement=document.getElementById("montantPaiement");
const validerPaiement=document.getElementById("validerPaiement");
const msgPaiement=document.getElementById("msgPaiement");
const retourAdmin=document.getElementById("retourAdmin");

function updateAdminTable(){
  adminTable.innerHTML="";
  abonnés.forEach(a=>{
    const comptesStr=a.comptes.map(c=>c.fournisseur+": "+c.numero).join(" | ");
    const tr=document.createElement("tr");
    const lien=`javascript:openAbonne('${a.id}')`;
    const btnEtat=a.ouvert?'Ouvert':'Fermé';
    tr.innerHTML=`<td>${a.entreprise}</td><td>${a.proprietaire}</td><td>${comptesStr}</td><td>${a.montants.join(", ")}</td><td>${a.montants.join(", ")}</td><td>${a.compteur}</td><td>${a.totalDepenses}</td><td><a href="${lien}">Voir</a></td><td>${btnEtat}</td>`;
    adminTable.appendChild(tr);
  });
}

accessBtn.addEventListener("click",()=>{
  if(adminCodeInput.value.trim()===ADMIN_CODE){
    accessMsg.textContent="✅ Accès autorisé";
    updateAdminTable();
  }else{
    accessMsg.textContent="❌ Code incorrect";
  }
});

function openAbonne(id){
  const ab=abonnés.find(a=>a.id===id);
  if(!ab || !ab.ouvert) return alert("Abonné fermé ou introuvable");
  adminSection.classList.add("hidden");
  userSection.classList.remove("hidden");
  showAbonne(ab);
}

function showAbonne(a){
  abonneDetail.classList.remove("hidden");
  abonneNom.textContent = a.proprietaire;
  abonneEntreprise.textContent = a.entreprise;
  abonneProprietaire.textContent = a.proprietaire;
  abonneComptes.textContent = a.comptes.map(c=>c.fournisseur+": "+c.numero).join(" | ");
  abonneMontants.textContent = "—"; // Ne pas afficher les montants autorisés
}

searchAbonne.addEventListener("input",()=>{
  const val=searchAbonne.value.toLowerCase();
  abonneList.innerHTML="";
  abonnés.filter(a=>a.proprietaire.toLowerCase().includes(val)||a.entreprise.toLowerCase().includes(val)).forEach(a=>{
    if(a.ouvert){
      const li=document.createElement("li");
      li.textContent=a.proprietaire+" ("+a.entreprise+")";
      li.addEventListener("click",()=>showAbonne(a));
      abonneList.appendChild(li);
    }
  });
});

validerPaiement.addEventListener("click", () => {
  const message = messagePaiement.value.trim();
  const montant = parseFloat(montantPaiement.value.trim());
  const ab = abonnés.find(a => a.proprietaire === abonneNom.textContent);

  if (!message || !montant) {
    msgPaiement.textContent = "Veuillez remplir le message et le montant.";
    return;
  }

  // Regex robuste pour le message Mobile Money
  const regex = /a\s(.+?)\s\((\+?\d+)\).*transaction Id:\s(\d+)/i;
  const match = message.match(regex);

  if (!match) {
    msgPaiement.textContent = "Message Mobile Money invalide.";
    return;
  }

  const [_, nomAbonneMsg, numeroAbonneMsg, idTransaction] = match;

  // Normalisation pour ignorer accents, majuscules, espaces
  function normalizeStr(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g,'');
  }

  const nomAbonneNorm = normalizeStr(nomAbonneMsg);
  const proprietaireNorm = normalizeStr(ab.proprietaire);

  // Vérifie que le prénom et le nom principal correspondent
  const nomCorrespond = proprietaireNorm.split(/(?=[A-Z])/).every(part => nomAbonneNorm.includes(part) || part.length < 3);

  // Numéro correspond à l’un des comptes
  const numeroNorm = numeroAbonneMsg.replace(/\D/g,''); // retire tout sauf chiffres
  const numeroCorrespond = ab.comptes.some(c => c.numero.replace(/\D/g,'') === numeroNorm);

  if (!nomCorrespond || !numeroCorrespond) {
    msgPaiement.textContent = "Erreur : le paiement ne correspond pas à cet abonné.";
    return;
  }

  // Vérification unicité ID de transaction
  if (ab.transactions.some(t => t.id === idTransaction)) {
    msgPaiement.textContent = "Transaction déjà utilisée : paiement non valide.";
    return;
  }

  // Paiement validé
  ab.transactions.push({
    id: idTransaction,
    montant: montant,
    message: message,
    initiatedBy: "user",
    status: "completed",
    date: new Date().toLocaleString()
  });

  ab.compteur += 1;
  ab.totalDepenses += montant;

  msgPaiement.textContent = `✅ Paiement validé pour ${abonneNom.textContent}`;

  montantPaiement.value = "";
  messagePaiement.value = "";
  updateAdminTable();
});

retourAdmin.addEventListener("click",()=>{
  userSection.classList.add("hidden");
  adminSection.classList.remove("hidden");
});
</script>

</body>
</html>