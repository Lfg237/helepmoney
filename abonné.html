<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Abonné HelpMoney</title>
<style>
body { font-family: Arial, sans-serif; background:#f0f0f0; margin:0; padding:0; }
.container { max-width: 800px; margin:50px auto; padding:20px; background:white; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2); }
h1 { text-align:center; color:#ff5722; }
p.error { color:red; font-weight:bold; text-align:center; }
table { width:100%; border-collapse: collapse; margin-top:20px; }
th,td { padding:12px; border:1px solid #ddd; text-align:center; }
th { background:#ff9800; color:white; }
input,textarea,button { width:100%; padding:10px; margin-top:10px; border-radius:5px; border:1px solid #ff5722; }
button { background:#ff5722; color:white; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>
<div class="container" id="container">
  <h1>Page Abonné</h1>
</div>

<script>
// Les mêmes abonnés que dans index.html
const abonnés = [
  {
    entreprise:"FACILITATEURS",
    proprietaire:["Jean Dupont"],
    numero:["655123456","677889900"],
    fournisseur:["Orange Money","MTN MoMo"],
    montants:["2000","3000"],
    id:"123456",
    ouvert:true
  },
  {
    entreprise:"TECH SOLUTIONS",
    proprietaire:["LOVELINE KINYUY WIRNKAR"],
    numero:["676353859"],
    fournisseur:["MTN MoMo"],
    montants:["50","25","55"],
    id:"654321",
    ouvert:true
  },
  {
    entreprise:"ABC ENTERPRISE",
    proprietaire:["Paul Etoundi"],
    numero:["699112233"],
    fournisseur:["Orange Money"],
    montants:["2500"],
    id:"987654",
    ouvert:false
  }
];

const container = document.getElementById("container");

// Récupérer ID depuis URL
const urlParams = new URLSearchParams(window.location.search);
const abonneId = urlParams.get("abonne");

const abonne = abonnés.find(a => a.id === abonneId);

if(!abonne){
  container.innerHTML = "<p class='error'>Abonné introuvable.</p>";
} else if(!abonne.ouvert){
  container.innerHTML = "<p class='error'>Abonné fermé. Les informations sont cachées.</p>";
} else {
  // Page abonné affichage
  const proprietaires = abonne.proprietaire.join(", ");
  const numeros = abonne.numero.join(", ");
  const fournisseurs = abonne.fournisseur.join(", ");
  const montants = abonne.montants.join(", ");

  container.innerHTML += `
    <p><strong>Entreprise:</strong> ${abonne.entreprise}</p>
    <p><strong>Propriétaires:</strong> ${proprietaires}</p>
    <p><strong>Numéros:</strong> ${numeros}</p>
    <p><strong>Fournisseurs:</strong> ${fournisseurs}</p>
    <p><strong>Montants autorisés:</strong> ${montants}</p>

    <textarea id="inputPaiement" rows="4" placeholder="Collez le message Mobile Money"></textarea>
    <input type="number" id="inputMontant" placeholder="Montant payé">
    <button id="verifPaiementBtn">Valider le paiement</button>
    <p id="msg"></p>
  `;

  // Stockage local
  const STORAGE_TX = "processedTxIds_v1";
  const processedTxIds = JSON.parse(localStorage.getItem(STORAGE_TX)) || {};

  const inputPaiement = document.getElementById("inputPaiement");
  const inputMontant = document.getElementById("inputMontant");
  const verifPaiementBtn = document.getElementById("verifPaiementBtn");
  const msg = document.getElementById("msg");

  function parseAmount(str){
    return parseFloat(String(str).replace(/[^0-9.]/g,"")) || 0;
  }

  verifPaiementBtn.addEventListener("click", ()=>{
    const texte = inputPaiement.value.trim();
    const montantUser = inputMontant.value.trim();

    if(!texte){ alert("Collez d'abord le message Mobile Money."); return; }
    if(!montantUser){ alert("Entrez le montant payé."); return; }

    // Vérification doublon via hash du message
    const txId = "TX_" + btoa(texte).slice(0,12);
    if(processedTxIds[txId]){
      alert("⚠️ Paiement déjà validé.");
      return;
    }

    // Vérification nom + montant
    const nomOK = abonne.proprietaire.some(n => texte.toLowerCase().includes(n.split(" ")[0].toLowerCase()));
    const montantOK = abonne.montants.includes(montantUser);

    if(!nomOK){
      alert("Nom de l'abonné non trouvé dans le message.");
      return;
    }
    if(!montantOK){
      alert(`Montant non autorisé. Montants acceptés : ${abonne.montants.join(", ")}`);
      return;
    }

    processedTxIds[txId] = { abonneId: abonne.id, montant: montantUser, date: new Date().toISOString() };
    localStorage.setItem(STORAGE_TX, JSON.stringify(processedTxIds));
    alert(`✅ Paiement validé: ${montantUser} FCFA`);
    inputPaiement.value = ""; inputMontant.value = "";
  });
}
</script>
</body>
</html>